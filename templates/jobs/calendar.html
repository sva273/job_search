{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Calendar" %}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <h2 class="mb-3 mb-md-0">
                <i class="bi bi-calendar-event"></i> {% trans "Calendar" %}
            </h2>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-primary" id="viewMonth">{% trans "Month" %}</button>
                <button type="button" class="btn btn-sm btn-outline-primary" id="viewWeek">{% trans "Week" %}</button>
                <button type="button" class="btn btn-sm btn-outline-primary" id="viewDay">{% trans "Day" %}</button>
            </div>
        </div>
    </div>
</div>

<!-- Calendar View -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Interviews -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header card-header-primary">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-check"></i> {% trans "Upcoming Interviews" %}
                </h5>
            </div>
            <div class="card-body">
                {% if interviews %}
                    <div class="list-group list-group-flush">
                        {% for job in interviews %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            <a href="{% url 'jobs:job_detail' job.id %}" class="text-decoration-none">
                                                {{ job.job_title }}
                                            </a>
                                        </h6>
                                        <p class="mb-1 text-muted small">
                                            <i class="bi bi-building"></i> {{ job.employer }}
                                        </p>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar"></i> {{ job.interview_date|date:"d.m.Y H:i" }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center py-3">
                        <i class="bi bi-calendar-x"></i> {% trans "No upcoming interviews" %}
                    </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Follow-ups -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header card-header-success">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-plus"></i> {% trans "Follow-ups" %}
                </h5>
            </div>
            <div class="card-body">
                {% if follow_ups %}
                    <div class="list-group list-group-flush">
                        {% for job in follow_ups %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            <a href="{% url 'jobs:job_detail' job.id %}" class="text-decoration-none">
                                                {{ job.job_title }}
                                            </a>
                                        </h6>
                                        <p class="mb-1 text-muted small">
                                            <i class="bi bi-building"></i> {{ job.employer }}
                                        </p>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar"></i> {{ job.follow_up_date|date:"d.m.Y H:i" }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center py-3">
                        <i class="bi bi-calendar-x"></i> {% trans "No follow-ups scheduled" %}
                    </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Deadlines -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header card-header-warning">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-x"></i> {% trans "Application Deadlines" %}
                </h5>
            </div>
            <div class="card-body">
                {% if deadlines %}
                    <div class="list-group list-group-flush">
                        {% for job in deadlines %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            <a href="{% url 'jobs:job_detail' job.id %}" class="text-decoration-none">
                                                {{ job.job_title }}
                                            </a>
                                        </h6>
                                        <p class="mb-1 text-muted small">
                                            <i class="bi bi-building"></i> {{ job.employer }}
                                        </p>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar"></i> {{ job.application_deadline|date:"d.m.Y" }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center py-3">
                        <i class="bi bi-calendar-x"></i> {% trans "No deadlines" %}
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: '{{ LANGUAGE_CODE|default:"ru" }}',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: [
                {% for job in all_interviews %}
                {
                    title: '{% trans "Interview" %}: {{ job.job_title|escapejs }} - {{ job.employer|escapejs }}',
                    start: '{{ job.interview_date|date:"Y-m-d\TH:i:s" }}',
                    url: '{% url "jobs:job_detail" job.id %}',
                    color: '#667eea',
                    textColor: 'white'
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
                {% if all_interviews and all_follow_ups %},{% endif %}
                {% for job in all_follow_ups %}
                {
                    title: '{% trans "Follow-up" %}: {{ job.job_title|escapejs }} - {{ job.employer|escapejs }}',
                    start: '{{ job.follow_up_date|date:"Y-m-d\TH:i:s" }}',
                    url: '{% url "jobs:job_detail" job.id %}',
                    color: '#11998e',
                    textColor: 'white'
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
                {% if (all_interviews or all_follow_ups) and all_deadlines %},{% endif %}
                {% for job in all_deadlines %}
                {
                    title: '{% trans "Deadline" %}: {{ job.job_title|escapejs }} - {{ job.employer|escapejs }}',
                    start: '{{ job.application_deadline|date:"Y-m-d" }}',
                    url: '{% url "jobs:job_detail" job.id %}',
                    color: '#f5576c',
                    textColor: 'white',
                    allDay: true
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            eventClick: function(info) {
                if (info.event.url) {
                    window.location.href = info.event.url;
                    return false;
                }
            },
            eventDisplay: 'block',
            height: 'auto'
        });
        calendar.render();

        // View buttons
        document.getElementById('viewMonth').addEventListener('click', function() {
            calendar.changeView('dayGridMonth');
        });
        document.getElementById('viewWeek').addEventListener('click', function() {
            calendar.changeView('timeGridWeek');
        });
        document.getElementById('viewDay').addEventListener('click', function() {
            calendar.changeView('timeGridDay');
        });
    });
</script>
{% endblock %}
{% endblock %}

