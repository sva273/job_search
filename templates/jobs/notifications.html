{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Notifications" %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-bell-fill"></i> {% trans "Notifications" %}</h2>
            <div class="d-flex align-items-center gap-2">
                {% if unread_count > 0 %}
                    <span class="badge unread-badge me-2" id="unread-count-badge">{{ unread_count }} {% trans "unread" %}</span>
                    <a href="{% url 'jobs:notifications' %}?mark_read=1" class="btn btn-sm btn-success mark-all-read-btn">
                        <i class="bi bi-check-all"></i> {% trans "Mark all as read" %}
                    </a>
                {% else %}
                    <span class="badge bg-secondary me-2" id="unread-count-badge" style="display: none;">0 {% trans "unread" %}</span>
                {% endif %}
                {% if notifications %}
                    <form method="post" action="{% url 'jobs:delete_all_notifications' %}" class="d-inline delete-all-notifications-form">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm delete-all-btn">
                            <i class="bi bi-trash-fill"></i> {% trans "Delete All" %}
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>

        {% if notifications %}
            <div class="card">
                <div class="card-header card-header-primary">
                    <h5 class="mb-0"><i class="bi bi-bell"></i> {% trans "All Notifications" %}</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for notification in notifications %}
                            <div class="list-group-item {% if not notification.is_read %}bg-light border-start border-primary border-3{% endif %}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            {% if notification.notification_type == 'success' %}
                                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                            {% elif notification.notification_type == 'warning' %}
                                                <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                                            {% elif notification.notification_type == 'danger' or notification.notification_type == 'error' %}
                                                <i class="bi bi-x-circle-fill text-danger me-2"></i>
                                            {% else %}
                                                <i class="bi bi-info-circle-fill text-info me-2"></i>
                                            {% endif %}
                                            <h6 class="mb-0 {% if not notification.is_read %}fw-bold{% endif %}">
                                                {{ notification.translated_title|default:notification.title }}
                                            </h6>
                                            {% if not notification.is_read %}
                                                <span class="badge bg-primary ms-2">{% trans "New" %}</span>
                                            {% endif %}
                                        </div>
                                        <p class="mb-2 {% if not notification.is_read %}fw-bold{% endif %}">
                                            {{ notification.translated_message|default:notification.message }}
                                        </p>
                                        <div class="d-flex align-items-center">
                                            <small class="text-muted me-3">
                                                <i class="bi bi-calendar"></i> {{ notification.created_at|date:"d.m.Y H:i" }}
                                            </small>
                                            {% if notification.job_entry %}
                                                <a href="{% url 'jobs:job_detail' notification.job_entry.id %}" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-eye"></i> {% trans "View Job" %}
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="ms-3 d-flex gap-2 align-items-center">
                                        {% if not notification.is_read %}
                                            <a href="{% url 'jobs:mark_notification_read' notification.id %}" 
                                               class="btn btn-sm btn-outline-success mark-read-btn" 
                                               data-notification-id="{{ notification.id }}"
                                               data-read-text="{% trans 'Read' %}"
                                               data-unread-text="{% trans 'unread' %}"
                                               title="{% trans 'Mark as read' %}">
                                                <i class="bi bi-check"></i> {% trans "Mark as read" %}
                                            </a>
                                        {% else %}
                                            <span class="badge bg-secondary">{% trans "Read" %}</span>
                                        {% endif %}
                                        <form method="post" action="{% url 'jobs:delete_notification' notification.id %}" class="d-inline delete-notification-form" data-confirm-message="{% trans 'Are you sure you want to delete this notification?' %}">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="{% trans 'Delete' %}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-bell-slash icon-xl icon-muted"></i>
                    <p class="text-muted mt-3">{% trans "No notifications yet" %}</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Delete Notification Confirmation Modal -->
<div class="modal fade" id="deleteNotificationModal" tabindex="-1" aria-labelledby="deleteNotificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header delete-modal-header text-white">
                <h5 class="modal-title" id="deleteNotificationModalLabel">
                    <i class="bi bi-exclamation-triangle-fill"></i> {% trans "Delete Notification" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="bi bi-trash3-fill delete-modal-icon" style="font-size: 3rem;"></i>
                </div>
                <h6 class="mb-3">{% trans "Are you sure you want to delete this notification?" %}</h6>
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-info-circle-fill"></i> <strong>{% trans "This action cannot be undone!" %}</strong>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> {% trans "Cancel" %}
                </button>
                <button type="button" class="btn delete-modal-btn" id="confirmDeleteNotificationBtn">
                    <i class="bi bi-trash-fill"></i> {% trans "Yes, Delete" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete All Notifications Confirmation Modal -->
<div class="modal fade" id="deleteAllNotificationsModal" tabindex="-1" aria-labelledby="deleteAllNotificationsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header delete-modal-header text-white">
                <h5 class="modal-title" id="deleteAllNotificationsModalLabel">
                    <i class="bi bi-exclamation-triangle-fill"></i> {% trans "Delete All Notifications" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="bi bi-trash3-fill delete-modal-icon" style="font-size: 3rem;"></i>
                </div>
                <h6 class="mb-3">{% trans "Are you sure you want to delete all notifications?" %}</h6>
                <div class="alert delete-modal-alert mb-0">
                    <i class="bi bi-exclamation-triangle-fill"></i> <strong>{% trans "This will permanently delete all your notifications and cannot be undone!" %}</strong>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> {% trans "Cancel" %}
                </button>
                <button type="button" class="btn delete-modal-btn" id="confirmDeleteAllNotificationsBtn">
                    <i class="bi bi-trash-fill"></i> {% trans "Yes, Delete All" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle mark as read button clicks
    document.querySelectorAll('.mark-read-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const notificationId = this.getAttribute('data-notification-id');
            const btnElement = this;
            const readText = btnElement.getAttribute('data-read-text') || 'Read';
            const unreadText = btnElement.getAttribute('data-unread-text') || 'unread';
            
            // Make AJAX request to mark as read
            fetch(this.href, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the notification item
                    const listItem = btnElement.closest('.list-group-item');
                    listItem.classList.remove('bg-light', 'border-start', 'border-primary', 'border-3');
                    
                    // Remove bold styling from title and message
                    const titleElement = listItem.querySelector('h6');
                    const messageElement = listItem.querySelector('p');
                    if (titleElement) titleElement.classList.remove('fw-bold');
                    if (messageElement) messageElement.classList.remove('fw-bold');
                    
                    // Replace button with "Read" badge
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-secondary';
                    badge.textContent = readText;
                    btnElement.parentElement.replaceChild(badge, btnElement);
                    
                    // Remove "New" badge if exists
                    const newBadge = listItem.querySelector('.badge.bg-primary');
                    if (newBadge) {
                        newBadge.remove();
                    }
                    
                    // Update unread count in navigation
                    const navLink = document.querySelector('.nav-link[href*="notifications"]');
                    if (navLink) {
                        let navBadge = navLink.querySelector('.badge');
                        const newCount = data.unread_count;
                        if (newCount > 0) {
                            if (!navBadge) {
                                navBadge = document.createElement('span');
                                navBadge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill unread-badge';
                                navBadge.style.fontSize = '0.7rem';
                                navLink.appendChild(navBadge);
                            }
                            navBadge.textContent = newCount;
                            navBadge.style.display = 'inline';
                        } else {
                            if (navBadge) {
                                navBadge.style.display = 'none';
                            }
                        }
                    }
                    
                    // Update unread count on notifications page
                    const pageBadge = document.getElementById('unread-count-badge');
                    if (pageBadge) {
                        const newCount = data.unread_count;
                        // Get unread text from badge or use default
                        const currentText = pageBadge.textContent.trim();
                        const unreadTextMatch = currentText.match(/\d+\s+(.+)/);
                        const unreadTextValue = unreadTextMatch ? unreadTextMatch[1] : unreadText;
                        
                        if (newCount > 0) {
                            pageBadge.textContent = newCount + ' ' + unreadTextValue;
                            pageBadge.style.display = 'inline-block';
                            pageBadge.classList.remove('bg-secondary');
                            pageBadge.classList.add('unread-badge');
                        } else {
                            pageBadge.style.display = 'none';
                            // Hide "Mark all as read" button if exists
                            const markAllBtn = document.querySelector('.mark-all-read-btn');
                            if (markAllBtn) {
                                markAllBtn.style.display = 'none';
                            }
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Fallback to regular redirect if AJAX fails
                window.location.href = btnElement.href;
            });
        });
    });
    
    // Handle "Mark all as read" button click
    const markAllReadBtn = document.querySelector('.mark-all-read-btn');
    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const btnElement = this;
            const markAllUrl = this.href;
            
            // Make AJAX request to mark all as read
            fetch(markAllUrl, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                if (response.redirected) {
                    // If redirect, it means it's not an AJAX request, reload page
                    window.location.href = response.url;
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    // Update all notification items
                    document.querySelectorAll('.list-group-item').forEach(function(listItem) {
                        listItem.classList.remove('bg-light', 'border-start', 'border-primary', 'border-3');
                        
                        // Remove bold styling
                        const titleElement = listItem.querySelector('h6');
                        const messageElement = listItem.querySelector('p');
                        if (titleElement) titleElement.classList.remove('fw-bold');
                        if (messageElement) messageElement.classList.remove('fw-bold');
                        
                        // Replace "Mark as read" button with "Read" badge
                        const markReadBtn = listItem.querySelector('.mark-read-btn');
                        if (markReadBtn) {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary';
                            badge.textContent = markReadBtn.getAttribute('data-read-text') || 'Read';
                            markReadBtn.parentElement.replaceChild(badge, markReadBtn);
                        }
                        
                        // Remove "New" badge
                        const newBadge = listItem.querySelector('.badge.bg-primary');
                        if (newBadge) {
                            newBadge.remove();
                        }
                    });
                    
                    // Update unread count in navigation
                    const navLink = document.querySelector('.nav-link[href*="notifications"]');
                    if (navLink) {
                        const navBadge = navLink.querySelector('.badge');
                        if (navBadge) {
                            navBadge.style.display = 'none';
                        }
                    }
                    
                    // Update unread count on notifications page
                    const pageBadge = document.getElementById('unread-count-badge');
                    if (pageBadge) {
                        pageBadge.style.display = 'none';
                    }
                    
                    // Hide "Mark all as read" button
                    btnElement.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Fallback to regular redirect if AJAX fails
                window.location.href = markAllUrl;
            });
        });
    }
    
    // Handle delete notification button clicks
    let currentDeleteForm = null;
    let currentDeleteUrl = null;
    let currentNotificationItem = null;
    
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteNotificationModal'));
    const confirmDeleteBtn = document.getElementById('confirmDeleteNotificationBtn');
    
    document.querySelectorAll('.delete-notification-form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            currentDeleteForm = this;
            currentNotificationItem = this.closest('.list-group-item');
            currentDeleteUrl = this.action;
            
            // Show modal instead of confirm dialog
            deleteModal.show();
        });
    });
    
    // Handle confirm delete button click
    confirmDeleteBtn.addEventListener('click', function() {
        if (!currentDeleteUrl || !currentNotificationItem) {
            return;
        }
        
        // Close modal
        deleteModal.hide();
        
        // Make AJAX request to delete notification
        fetch(currentDeleteUrl, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': currentDeleteForm.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the notification item from the DOM
                    currentNotificationItem.style.transition = 'opacity 0.3s';
                    currentNotificationItem.style.opacity = '0';
                    setTimeout(() => {
                        currentNotificationItem.remove();
                        
                        // Check if there are any notifications left
                        const remainingNotifications = document.querySelectorAll('.list-group-item');
                        if (remainingNotifications.length === 0) {
                            // Reload page to show "No notifications" message
                            window.location.reload();
                        }
                    }, 300);
                    
                    // Update unread count in navigation
                    const navLink = document.querySelector('.nav-link[href*="notifications"]');
                    if (navLink) {
                        let navBadge = navLink.querySelector('.badge');
                        const newCount = data.unread_count;
                        if (newCount > 0) {
                            if (!navBadge) {
                                navBadge = document.createElement('span');
                                navBadge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill unread-badge';
                                navBadge.style.fontSize = '0.7rem';
                                navLink.appendChild(navBadge);
                            }
                            navBadge.textContent = newCount;
                            navBadge.style.display = 'inline';
                        } else {
                            if (navBadge) {
                                navBadge.style.display = 'none';
                            }
                        }
                    }
                    
                    // Update unread count on notifications page
                    const pageBadge = document.getElementById('unread-count-badge');
                    if (pageBadge) {
                        const newCount = data.unread_count;
                        // Get unread text from badge or use default
                        const currentText = pageBadge.textContent.trim();
                        const unreadTextMatch = currentText.match(/\d+\s+(.+)/);
                        const unreadTextValue = unreadTextMatch ? unreadTextMatch[1] : 'unread';
                        
                        if (newCount > 0) {
                            pageBadge.textContent = newCount + ' ' + unreadTextValue;
                            pageBadge.style.display = 'inline-block';
                            pageBadge.classList.remove('bg-secondary');
                            pageBadge.classList.add('unread-badge');
                        } else {
                            pageBadge.style.display = 'none';
                            // Hide "Mark all as read" button if exists
                            const markAllBtn = document.querySelector('.mark-all-read-btn');
                            if (markAllBtn) {
                                markAllBtn.style.display = 'none';
                            }
                        }
                    }
                    
                    // Reset variables
                    currentDeleteForm = null;
                    currentDeleteUrl = null;
                    currentNotificationItem = null;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Fallback to regular form submission if AJAX fails
                if (currentDeleteForm) {
                    currentDeleteForm.submit();
                }
            });
    });
    
    // Handle "Delete All" notifications form
    const deleteAllForm = document.querySelector('.delete-all-notifications-form');
    const deleteAllModal = new bootstrap.Modal(document.getElementById('deleteAllNotificationsModal'));
    const confirmDeleteAllBtn = document.getElementById('confirmDeleteAllNotificationsBtn');
    
    if (deleteAllForm) {
        deleteAllForm.addEventListener('submit', function(e) {
            e.preventDefault();
            deleteAllModal.show();
        });
    }
    
    // Handle confirm delete all button click
    if (confirmDeleteAllBtn) {
        confirmDeleteAllBtn.addEventListener('click', function() {
            deleteAllModal.hide();
            if (deleteAllForm) {
                // Submit form normally (not AJAX, as it redirects)
                deleteAllForm.submit();
            }
        });
    }
});
</script>
{% endblock %}

